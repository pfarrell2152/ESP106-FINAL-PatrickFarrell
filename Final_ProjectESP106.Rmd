---
title: "Project ESP 106"
output: html_document
date: "2024-03-06"
author: Patrick Farrell
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
Loading packages and data for analysis across vineyards
```{r}
library(ggstats)
library(tidyverse)
library(dplyr)
library(ggplot2)


PASO_SOIL_df<- read.csv("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/PasoRobles_SHdata.csv")

#Make categorical data as factors
PASO_SOIL_df<- PASO_SOIL_df %>% mutate_at(1:7, as.factor)

#Summarize data 
PASO_SOIL_dfsum <- PASO_SOIL_df %>% group_by(Grower, Grower.Rating, Location, Depth) %>% summarize_at(vars(EC:TN), list(mean=mean, sd=sd, max=max, min=min, median=median),na.rm = TRUE)

#Colorblind palette
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# first row is NA so delete
PASO_SOIL_dfsum <-PASO_SOIL_dfsum[-1,]

# for loop for making a individual data set for each soil health factor
## Make data frame alphabetical to make for loop easier (except fo the first 4 rows)

first_four_column <- PASO_SOIL_dfsum[,1:4 ]

rest_of_col <- PASO_SOIL_dfsum[,-(1:4) ]

rest_of_col_sorted <- rest_of_col[, order(names(rest_of_col))]

PASO_dfsum_sorted <- cbind(first_four_column,rest_of_col_sorted) 

## for loop for creating a data frame for each soil measurement

# Define the column ranges for each data frame

BD_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,5:9)]

clay_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,10:14)]

EC_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,15:19)]

MBC_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,20:24)]

NH4_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,25:29)]

NO3_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,30:34)]

pH_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,35:39)]

PMN_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,40:44)]

POXC_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,45:49)]

Sand_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,50:54)]

silt_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,55:59)]

Soil_Moisture_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,60:64)]

TC_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,65:69)]

TN_sum_df <- PASO_dfsum_sorted[,c(1,2,3,4,70:74)]

```

Now I will repeat these steps for Lodi and Napa data sets.

```{r}
NAPA_SOIL_df<- read.csv("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/Napa_SHData.csv")


#Make categorical data as factors
NAPA_SOIL_df<- NAPA_SOIL_df %>% mutate_at(1:7, as.factor)

#Summarize data 
NAPA_SOIL_df_sum <- NAPA_SOIL_df %>% group_by(Grower, Grower.Rating, Location, Depth) %>% summarize_at(vars(EC:TN), list(mean=mean, sd=sd, max=max, min=min, median=median),na.rm = TRUE)



# for loop for making a individual data set for each soil health factor
## Make data frame alphabetical to make for loop easier (except fo the first 4 rows)

first_four_column_NAPA <- NAPA_SOIL_df_sum[,1:4 ]

rest_of_col_NAPA <- NAPA_SOIL_df_sum[,-(1:4) ]

rest_of_col_sorted_NAPA <- rest_of_col_NAPA[, order(names(rest_of_col_NAPA))]

NAPA_SOIL_df_sorted <- cbind(first_four_column_NAPA,rest_of_col_sorted_NAPA) 

## for loop for creating a data frame for each soil measurement

# Define the column ranges for each data frame

NAPA_BD_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,5:9)]

NAPA_clay_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,10:14)]

NAPA_EC_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,15:19)]

NAPA_MBC_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,20:24)]

NAPA_NH4_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,25:29)]

NAPA_NO3_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,30:34)]

NAPA_pH_sum_df <-NAPA_SOIL_df_sorted[,c(1,2,3,4,35:39)]

NAPA_PMN_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,40:44)]

NAPA_POXC_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,45:49)]

NAPA_Sand_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,50:54)]

NAPA_silt_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,55:59)]

NAPA_Soil_Moisture_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,60:64)]

NAPA_TC_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,65:69)]

NAPA_TN_sum_df <- NAPA_SOIL_df_sorted[,c(1,2,3,4,70:74)]


```
LODI
```{r}
LODI_SOIL_df<- read.csv("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/Lodi_AVF_SHdata.csv")


#Make categorical data as factors
LODI_SOIL_df<- LODI_SOIL_df %>% mutate_at(1:5, as.factor)

#Summarize data 
LODI_SOIL_df_sum <- LODI_SOIL_df %>% group_by(Grower, Grower.Rating, Location, Depth) %>% summarize_at(vars(EC:PMN), list(mean=mean, sd=sd, max=max, min=min, median=median),na.rm = TRUE)


## Make data frame alphabetical to make for loop easier (except fo the first 4 rows)

first_four_column_LODI <- LODI_SOIL_df_sum[,1:4 ]

rest_of_col_LODI <- LODI_SOIL_df_sum[,-(1:4) ]

rest_of_col_sorted_LODI <- rest_of_col_LODI[, order(names(rest_of_col_LODI))]

LODI_SOIL_df_sorted <- cbind(first_four_column_LODI,rest_of_col_sorted_LODI) 

###

LODI_BD_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,5:9)]

LODI_EC_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,10:14)]

LODI_MBC_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,15:19)]

LODI_NH4_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,20:24)]

LODI_pH_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,25:29)]

LODI_PMN_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,30:34)]

LODI_POXC_sum_df <-LODI_SOIL_df_sorted[,c(1,2,3,4,35:39)]

LODI_Respiration_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,40:44)]

LODI_SOIL_moisture_sum_df <- LODI_SOIL_df_sorted[,c(1,2,3,4,45:49)]


### missing data so not as many sub data frames as other regoins
```
This code will make a plot for comparing pH of every grower in the regions . A similar plot could be made for every soil health measurement to compare which soil has the most favorable soil health factors.
```{r}

pH_Grower_plot_PASO<- ggplot(pH_sum_df,aes(y=pH_mean, x=Grower, fill=Depth)) + geom_boxplot(outlier.shape=NA) +theme_bw() + scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x=element_text (hjust=0.5, angle = 45, size = 12), axis.title.x = element_text(size=10), axis.title.y = element_text(size=14), plot.title = element_text(size=18), strip.text.x = element_text(size = 12),strip.text.y = element_text(size = 12), axis.text.y.left =element_text( size = 12), legend.text=element_text(size=12), legend.title=element_text(size=12)) + 
  ylab(expression(paste('pH' ))) 

pH_Grower_plot_PASO


```{r}

pH_Grower_plot_NAPA<- ggplot(NAPA_pH_sum_df,aes(y=pH_mean, x=Grower, fill=Depth)) + geom_boxplot(outlier.shape=NA) +theme_bw() + scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x=element_text (hjust=0.5, angle = 45, size = 12), axis.title.x = element_text(size=10), axis.title.y = element_text(size=14), plot.title = element_text(size=18), strip.text.x = element_text(size = 12),strip.text.y = element_text(size = 12), axis.text.y.left =element_text( size = 12), legend.text=element_text(size=12), legend.title=element_text(size=12)) + 
  ylab(expression(paste('pH' ))) 

pH_Grower_plot_NAPA
```

```{r}
pH_Grower_plot_LODI<- ggplot(LODI_pH_sum_df,aes(y=pH_mean, x=Grower, fill=Depth)) + geom_boxplot(outlier.shape=NA) +theme_bw() + scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x=element_text (hjust=0.5, angle = 45, size = 12), axis.title.x = element_text(size=10), axis.title.y = element_text(size=14), plot.title = element_text(size=18), strip.text.x = element_text(size = 12),strip.text.y = element_text(size = 12), axis.text.y.left =element_text( size = 12), legend.text=element_text(size=12), legend.title=element_text(size=12)) + 
  ylab(expression(paste('pH' ))) 

pH_Grower_plot_LODI

```

Now I would like avergae pH for the entire region. 

```{r}


```
##Raster Data
First let read in data set of vineyard coordinates that I created. 
```{r}

Vineyards <- read.csv("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/Vineyard Coordinates.csv")

```
For the second part of my project I am going to use raster data to see the the precipitation level in each region. Data dowloaded from worldclim.org

```{r}
library(raster)


monthly_files <- list.files("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/wc2.1_10m_tavg", pattern = "\\.tif$", full.names = TRUE)
monthly_rasters <- lapply(monthly_files, raster)


stacked_raster <- stack(monthly_rasters)


yearly_temp_raster <- calc(stacked_raster, mean)  
```



```{r}
extent(yearly_temp_raster)

ca_boundary <- shapefile("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/ca_state_boundary/ca_state_boundaries.shp")

ytr<- crop(yearly_temp_raster,extent(ca_boundary))

plot(ytr[[1]] , main="Mean Annual Temperature")
plot(ca_boundary, add=TRUE, border="black",lwd=2)
points(Vineyards$Longitude, Vineyards$Latitude, pch = 1, col = "blue", cex= .5)


```

We can see from this that Paso Robles and Napa have lower average temperature. 

Now Precipitation
```{r}
monthly_precip <- list.files("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/wc2.1_10m_prec", pattern = "\\.tif$", full.names = TRUE)

monthly_precip_rasters <- lapply(monthly_precip, raster)


stacked_precip <- stack(monthly_precip_rasters)


yearly_precip_raster <- calc(stacked_precip, mean)

ypr<- crop(yearly_precip_raster,extent(ca_boundary))

plot(ypr[[1]], main= "Mean Average Precipitation")
plot(ca_boundary, add=TRUE, border="black",lwd=2)
points(Vineyards$Longitude, Vineyards$Latitude, pch = 1, col = "blue", cex= .5)

```

Hard to see differences so lets zoom in on each growing region. using shapefiels of wine growing avas from ttb.gov

```{r}
napa_boundary<- shapefile("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/napa_valley/napa_valley.shp")

ypr_napa<- crop(yearly_precip_raster,extent(napa_boundary))

plot(ypr_napa[[1]], main= "Napa Valley Vineyard and Mean Average Precipitation")
plot(napa_boundary, add=TRUE, border="black",lwd=2)
points(Vineyards$Longitude, Vineyards$Latitude, pch = 1, col = "blue", cex= .5)


```


```{r}
lodi_boundary<- shapefile("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/lodi/lodi.shp")

ypr_lodi<- crop(yearly_precip_raster,extent(lodi_boundary))

plot(ypr_lodi[[1]], main= "Lodi Vineyards and Mean Average Precipitation")
plot(lodi_boundary, add=TRUE, border="black",lwd=2)
points(Vineyards$Longitude, Vineyards$Latitude, pch = 1, col = "blue", cex= .5)
```

```{r}
paso_boundary<- shapefile("/Users/patrickfarrell/Documents/School/ESP 106/ESP106-FINAL-PatrickFarrell/paso_robles/paso_robles.shp")

ypr_paso<- crop(yearly_precip_raster,extent(paso_boundary))

plot(ypr_paso[[1]], main= "Paso Robles Vineyards and Mean Average Precipitation")
plot(paso_boundary, add=TRUE, border="black",lwd=2)
points(Vineyards$Longitude, Vineyards$Latitude, pch = 1, col = "blue", cex= .5)

```


There a re couple issues with these plots. The raster that I am using does not have enough cells to clearly differentiate precipitation within a region. However, we are able to se that Napa gets more precipitation on average than Paso Robles and Lodi. 